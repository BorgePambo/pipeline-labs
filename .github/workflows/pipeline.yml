name: Info Banco de Dados

on:
  workflow_dispatch:  # permite rodar manualmente

jobs:
  postgres-info:
    runs-on: ubuntu-latest

    # Rodando Postgres como serviço dentro do workflow
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ secrets.DB_USER }}        # usuário do banco
          POSTGRES_PASSWORD: ${{ secrets.DB_PASS }}    # senha do banco
          POSTGRES_DB: ${{ secrets.DB_NAME }}          # nome do banco
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U 
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DB_HOST: localhost
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
      DB_NAME: ${{ secrets.DB_NAME }}

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar dependências Python
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary

      - name: Conectar e imprimir info do banco
        run: |
          python - <<EOF
          import os
          import psycopg2
          from time import sleep

          # Espera alguns segundos até o Postgres estar pronto
          sleep(10)

          conn = psycopg2.connect(
              host=os.environ['DB_HOST'],
              user=os.environ['DB_USER'],
              password=os.environ['DB_PASS'],
              dbname=os.environ['DB_NAME']
          )

          cur = conn.cursor()
          cur.execute("SELECT version();")
          version = cur.fetchone()
          print("Versão do banco:", version[0])

          # Mostrando nomes de tabelas (se houver)
          cur.execute("SELECT table_name FROM information_schema.tables WHERE table_schema='public';")
          tables = cur.fetchall()
          print("Tabelas:", [t[0] for t in tables])

          cur.close()
          conn.close()
          EOF
